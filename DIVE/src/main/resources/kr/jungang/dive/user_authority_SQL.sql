DROP TABLE PERSISTENT_LOGINS;
DROP TABLE TBL_AUTHORITIES;
DROP SEQUENCE SEQ_AUTHORITIES;
DROP TABLE TBL_USER;
DROP SEQUENCE SEQ_USER;

--USER 시퀀스 생성
CREATE SEQUENCE SEQ_USER;
--USER 테이블 생성
CREATE TABLE TBL_USER (
USER_NUM NUMBER(10), 	
ID VARCHAR2(50) NOT NULL, 
PASSWORD VARCHAR2(100) NOT NULL, 
NAME VARCHAR2(50), 
SEX CHAR(1) NOT NULL, 
BIRTHDAY CHAR(10) NOT NULL, 
ADDRESS VARCHAR2(100), 
PHONE VARCHAR2(50), 
EMAIL VARCHAR2(50), 
REG_DATE DATE DEFAULT SYSDATE, 		
UPDATE_DATE DATE DEFAULT SYSDATE, 		
ENABLED CHAR(1) DEFAULT '1', 
CONSTRAINT PK_USER PRIMARY KEY(USER_NUM)
);

--회원가입 SQL
INSERT INTO TBL_USER 
(USER_NUM, ID, PASSWORD, NAME, SEX, BIRTHDAY, ADDRESS, PHONE, EMAIL, REG_DATE)
VALUES
(SEQ_USER.NEXTVAL, 'USER_A', 'USER_A', 'ANOLD', 'M', '2000-01-01', 'REPUBLIC OF KOREA', 
 '010-1234-5678', 'ANOLD@NAVER.COM', SYSDATE);
INSERT INTO TBL_USER 
(USER_NUM, ID, PASSWORD, NAME, SEX, BIRTHDAY, ADDRESS, PHONE, EMAIL, REG_DATE)
VALUES
(SEQ_USER.NEXTVAL, 'SUB', 'SUB', 'ANOLD', 'M', '2000-01-01', 'REPUBLIC OF KOREA', 
 '010-1234-5678', 'ANOLD@NAVER.COM', SYSDATE);

--INDEX 생성 : FULL SCAN에서 FAST FULL SCAN으로 바뀜
CREATE INDEX IDX_USER_ID ON TBL_USER(ID, PASSWORD);

--회원정보 수정 SQL
UPDATE TBL_USER
   SET phone = '010-8795-1354',
       update_date = sysdate
 WHERE id = 'MASTER';

--회원정보 삭제 SQL
DELETE
  FROM TBL_USER
 WHERE ID = 'TEST_A';

--권한 시퀀스 생성
CREATE SEQUENCE SEQ_AUTHORITIES;
--권한 테이블 생성
CREATE TABLE TBL_AUTHORITIES ( 	
USER_NUM NUMBER(10) NOT NULL, 
AUTHORITY VARCHAR2(100) NOT NULL,
--ON DELETE CASCADE는 참조하는 데이터 삭제시 FK함께 삭제, ON DELETE SET NULL은 참조하는 테이블의 데이터 삭제시 해당값을 NULL로 변경
CONSTRAINT FK_AUTHORITIES FOREIGN KEY(USER_NUM) REFERENCES TBL_USER(USER_NUM) ON DELETE CASCADE
);

--회원 로그인 정보 및 권한 확인
SELECT u.user_num, id, password, enabled, reg_date, update_date, authority
  FROM tbl_user u LEFT OUTER JOIN tbl_authorities a ON u.user_num = a.user_num
 WHERE u.user_num = 9;
 
 --자동로그인 관련 테이블 생성
 CREATE TABLE PERSISTENT_LOGINS (
 USERNAME VARCHAR2(50) NOT NULL,
 SERIES VARCHAR2(50),
 TOKEN VARCHAR2(50),
 LAST_USED TIMESTAMP NOT NULL,
 CONSTRAINT PK_TBL_PERSISTENT_LOGINS PRIMARY KEY(SERIES)
 );